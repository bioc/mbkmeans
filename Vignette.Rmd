 12---
title: "vignette"
author: "Yuwei Ni"
date: "10/15/2018"
output: html_document
---


#1 Installation


```{r}
install_github("drisso/mbkmeans")
```


#2 Introduction


This vignette provides an introductory example on how to work with the mbkmeans package, which is an implementation of the mini-batcg k-means algorithm for large single cell sequencing data.


```{r options, include=FALSE, message=FALSE, warning=FALSE}
knitr::opts_chunk$set(cache=FALSE, error=FALSE, message=FALSE, warning=FALSE)
library(TENxPBMCData)
library(scater)
library(SingleCellExperiment)
library(mbkmeans)
library(DelayedMatrixStats)
library(ClusterR)

```


#2.1 Example dataset


```{r}
tenx_pbmc4k <- TENxPBMCData(dataset = "pbmc4k")

#normalization
sce <- normalize(tenx_pbmc4k)

vars <- rowVars(logcounts(sce))
names(vars) <- rownames(sce)
vars <- sort(vars, decreasing = TRUE)

sce1000 <- sce[names(vars)[1:1000], 1:100]
```


#3 mbkmeans


mbkmeans package is an implementation of mini-batch k-means for large single cell sequencing data. The main funciton is mbkmeans function which provides centroids and clusters results based on input data. This funciton takes ant matrix-like object as input, such as SummarizedExperiment, SingleCellExperiment, matrix, DelayedMatrix and HDF5Matrix. In this example, the input is SingleCellExperiment object and returns a list object includings centroids, within-cluster-sum-of-squares(WCSS) per cluster, initialization, iters_per_initiazation and Clusters.


```{r}
res <- mbkmeans(sce1000, clusters = 5, 
                            reduceMethod = "none",
                            whichAssay = "logcounts")
```


The number of clusters is set through clusters option. In this case, we set there are total 5 clusters. For SingleCellExperiment matrix object, the function provides reduceMethod and whichAssay option. The reduceMethod is the results for large data to reduce dimensionality, and the default is Principal Component Analysis(PCA) method. The whichAssay is the assay to use as inpit to mini-batch k-means, and it is used only when reduceMethod option is "none". See ?mbkmeans for more details.


#3.1 parameters


There are many parameters for mbkmeans function which makes the function more flexible and suitable for more situations. 


#3.1.1 batch size calculation


The size of mini batches is set through batch_size parameter. The default value uses the blocksize funciton. The blocksize fucntion considers both the number of data column and the amount of RAM on the current matchine to calculate the batch size. The calculation uses get_ram funciton in benchmarkme package, and see benchmarkme vignette for more details.


```{r}
batchsize <- blocksize(sce1000)
```


#3.1.2 two different initializer ways


The preformance of mini-batch k-means greatly depends on the process of initialization. And there are two different initializer ways in mbkmeans: one is random initializer, the traditional method of initialization; the other is kmeans++. The default initializer way is "kmeans++". The percentage of data to use for the initialization centroids is set through init_fraction parameter, which should be larger than 0 and less than 1, and the default value is 0.25.


```{r}
res <- mbkmeans(sce1000, clusters = 5, 
                            reduceMethod = "none",
                            whichAssay = "logcounts",initializer = "random")

```


#4 Speed
```{r}
mat <- HDF5Array("benchmarking/pbmc3k_rectangular.h5", name = "counts")
data_hdf5 <- mat[1:1000,]
data_inmem <- as.matrix(data_hdf5)

data_sce <- SingleCellExperiment(assays = list(counts = data_hdf5))

#kmeans++
system.time(clusterR_res <- MiniBatchKmeans(t(data_inmem), clusters = 3, batch_size = 100, init_fraction = .1, max_iters = 10))

system.time(mbk_res<-mbkmeans(data_inmem,clusters = 3, batch_size = 100, init_fraction = .1, max_iters = 10))

system.time(mbk_res<-mbkmeans(data_hdf5,clusters = 3, batch_size = 100, init_fraction = .1, max_iters = 10))

system.time(mbk_res<-mbkmeans(data_sce, reduceMethod = NA, clusters = 3, batch_size = 100, init_fraction = .1, max_iters = 10))

#random
system.time(clusterR_res <- MiniBatchKmeans(t(data_inmem), clusters = 3, batch_size = 100, init_fraction = .1, max_iters = 10,initializer = "random"))

system.time(mbk_res<-mbkmeans(data_inmem,clusters = 3, batch_size = 100, init_fraction = .1, max_iters = 10,initializer = "random"))

system.time(mbk_res<-mbkmeans(data_hdf5,clusters = 3, batch_size = 100, init_fraction = .1, max_iters = 10,initializer = "random"))

system.time(mbk_res<-mbkmeans(data_sce, reduceMethod = NA, clusters = 3, batch_size = 100, init_fraction = .1, max_iters = 10,initializer = "random"))
```



